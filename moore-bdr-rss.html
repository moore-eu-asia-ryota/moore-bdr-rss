<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>RSS Feed Display</title>
  <!-- Load Google Fonts: Montserrat -->
  <link href="https://fonts.googleapis.com/css2?family=Montserrat&display=swap" rel="stylesheet">
  <!-- Load Font Awesome for social icons -->
  <link
    rel="stylesheet"
    href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
    integrity="sha512-papNM3e+1/9pLbt+IDaE9XHSZBRR5D5b9XpIm3Vbz1p7Ik1YElu3k6o+pS9JEc2Mq5a59a0GFqzF0hO0wX4Q2Q=="
    crossorigin="anonymous"
    referrerpolicy="no-referrer"
  />
  <style>
    /* Global font */
    html, body, div, p, h1, h2, h3, h4, h5, h6, button, a, span {
      font-family: 'Montserrat', sans-serif;
    }
    body {
      margin: 0;
      background-color: #f7f8fa;
    }
    /* Full-width container with internal padding */
    .feed-container {
      width: 100%;
      padding: 20px; /* This ensures a 20px gap from the container's sides */
      box-sizing: border-box;
      display: flex;
      flex-direction: column;
      gap: 20px;
      align-items: center;
    }
    /* White feed items always fill the container's padded width */
    .feed-item {
      background-color: white;
      border-radius: 10px;
      padding: 20px;
      box-shadow: 0 4px 8px rgba(0,0,0,0.1);
      width: 100%; /* Fills the width of .feed-container */
      box-sizing: border-box;
    }
    /* Category tags */
    .tags {
      display: flex;
      gap: 10px;
      margin-bottom: 10px;
      width: 100%;
    }
    .tag {
      background-color: white;
      color: #00aeef;
      font-weight: 700;
      font-size: 12px;
      padding: 3px 15px;
      border: 1px solid #00aeef;
      border-radius: 5px;
      text-transform: uppercase;
    }
    /* Title */
    .feed-item h2 {
      font-weight: 700;
      font-size: 20px;
      line-height: 30px;
      color: #004c6c;
      margin: 0 0 10px;
    }
    /* Date and share */
    .date-share {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 20px;
    }
    .date {
      font-weight: 400;
      font-size: 12px;
      line-height: 30px;
      color: lightsteelblue;
    }
    .share-icons {
      display: flex;
      gap: 10px;
    }
    .share-icons a {
      text-decoration: none;
      font-size: 16px;
      color: #888;
      transition: color 0.2s;
    }
    .share-icons a:hover {
      color: #555;
    }
    /* Separator */
    .separator {
      border: none;
      border-top: 1px solid #004c6c;
      height: 20px;
      margin: 5px 0;
      font-family: Arial, sans-serif;
      font-weight: 400;
      font-size: 14px;
      line-height: 20px;
      color: #004c6c;
    }
    /* Description container: using a child for content */
    .description {
      overflow: hidden;
      transition: max-height 0.7s ease-in-out;
      margin-bottom: 20px;
    }
    .description-content {
      font-weight: 400;
      font-size: 13px;
      line-height: 20px;
      color: #004c6c;
    }
    .description-content p {
      margin: 0 0 10px;
    }
    /* Source */
    .source {
      margin-bottom: 10px;
    }
    .source-label {
      font-weight: 700;
      font-size: 12px;
      line-height: 20px;
      color: #004c6c;
    }
    .source-content {
      font-weight: 400;
      font-size: 12px;
      line-height: 20px;
      color: #004c6c;
    }
    .toggle-description {
      background-color: #007bff;
      color: white;
      border: none;
      padding: 10px 15px;
      border-radius: 5px;
      font-size: 14px;
      cursor: pointer;
    }
    .toggle-description:hover {
      background-color: #0056b3;
    }
    /* Align button to right */
    .button-container {
      display: flex;
      justify-content: flex-end;
    }
    /* Pagination */
    .pagination-container {
      display: flex;
      gap: 10px;
      justify-content: center;
      margin-top: 20px;
    }
    .pagination-container button {
      background-color: #007bff;
      color: white;
      border: none;
      padding: 8px 12px;
      border-radius: 5px;
      font-size: 14px;
      cursor: pointer;
    }
    .pagination-container button:hover {
      background-color: #0056b3;
    }
    .pagination-container button.disabled {
      opacity: 0.5;
      pointer-events: none;
    }
    .pagination-container button.active {
      background-color: #0056b3;
    }
  </style>
</head>
<body>
  <div id="feed" class="feed-container">Loading feed...</div>
  <div id="pagination" class="pagination-container"></div>

  <script>
    // Convert raw text into paragraphs.
    function convertToParagraphs(text) {
      const paragraphs = text.split(/\r?\n+/).filter(line => line.trim() !== '');
      return paragraphs.map(p => `<p>${p.trim()}</p>`).join('');
    }

    // Return truncated version (50% of paragraphs).
    function getTruncatedParagraphs(text) {
      const paragraphs = text.split(/\r?\n+/).filter(line => line.trim() !== '');
      if (paragraphs.length <= 1) {
        return convertToParagraphs(text);
      } else {
        const halfCount = Math.floor(paragraphs.length / 2);
        const truncated = paragraphs.slice(0, halfCount);
        if (paragraphs.length > halfCount) {
          truncated[truncated.length - 1] += '...';
        }
        return truncated.map(p => `<p>${p.trim()}</p>`).join('');
      }
    }

    // Measure the new content height of the description's child.
    function measureNewHeight(descContainer, newContentHTML) {
      const clone = descContainer.cloneNode(true);
      clone.style.maxHeight = 'none';
      clone.style.visibility = 'hidden';
      clone.style.position = 'absolute';
      clone.querySelector('.description-content').innerHTML = newContentHTML;
      document.body.appendChild(clone);
      const newHeight = clone.querySelector('.description-content').scrollHeight;
      document.body.removeChild(clone);
      return newHeight;
    }

    // Animate description change.
    // The parameter 'expanding' is a boolean indicating if we're expanding (true) or collapsing (false).
    function animateDescription(descContainer, newContentHTML, expanding) {
      const content = descContainer.querySelector('.description-content');
      // Set current max-height.
      descContainer.style.maxHeight = content.scrollHeight + 'px';
      // Update content.
      content.innerHTML = newContentHTML;
      // Force reflow.
      void descContainer.offsetHeight;
      // Measure target height.
      const targetHeight = content.scrollHeight;
      // Animate to target height.
      descContainer.style.maxHeight = targetHeight + 'px';
      descContainer.addEventListener('transitionend', function handler() {
        if(expanding) {
          // After expanding, let it be auto.
          descContainer.style.maxHeight = 'auto';
        }
        descContainer.removeEventListener('transitionend', handler);
      });
    }

    const feedUrl = 'https://raw.githubusercontent.com/moore-eu-asia-ryota/moore-bdr-rss/refs/heads/main/moore-bdr-feed.xml';
    const itemsPerPage = 5;
    let currentPage = 1;
    let feedItemsData = [];
    let totalPages = 0;

    // Render articles.
    function renderPage(page) {
      const feedContainer = document.getElementById('feed');
      feedContainer.innerHTML = '';
      const startIndex = (page - 1) * itemsPerPage;
      const endIndex = startIndex + itemsPerPage;
      const pageItems = feedItemsData.slice(startIndex, endIndex);
      
      pageItems.forEach(data => {
        const feedItem = document.createElement('div');
        feedItem.classList.add('feed-item');
        
        const tagsHTML = data.categories.length 
          ? data.categories.map(cat => `<div class="tag">${cat}</div>`).join('') 
          : '';
        
        feedItem.innerHTML = `
          <div class="tags">${tagsHTML}</div>
          <h2>${data.title}</h2>
          <div class="date-share">
            <div class="date">${data.pubDate}</div>
            <div class="share-icons">
              <a class="share-icon facebook" href="https://www.facebook.com/sharer/sharer.php?u=${encodeURIComponent(data.link)}" target="_blank" title="Share on Facebook">
                <i class="fab fa-facebook-f"></i>
              </a>
              <a class="share-icon twitter" href="https://twitter.com/intent/tweet?url=${encodeURIComponent(data.link)}&text=${encodeURIComponent(data.title)}" target="_blank" title="Share on X">
                <i class="fab fa-twitter"></i>
              </a>
            </div>
          </div>
          <hr class="separator">
          <div class="description">
            <div class="description-content">
              ${data.truncatedDescriptionHTML}
            </div>
          </div>
          <div class="source">
            <span class="source-label">Source: </span>
            <span class="source-content">${data.source}</span>
          </div>
          <div class="button-container">
            <button class="toggle-description">Read full article</button>
          </div>
        `;
        feedContainer.appendChild(feedItem);
        // Set initial max-height for smooth collapse.
        const descContainer = feedItem.querySelector('.description');
        descContainer.style.maxHeight = descContainer.querySelector('.description-content').scrollHeight + 'px';
        
        // Toggle event.
        const toggleButton = feedItem.querySelector('.toggle-description');
        toggleButton.addEventListener('click', () => {
          const descCont = feedItem.querySelector('.description');
          const expanding = toggleButton.textContent === 'Read full article';
          animateDescription(descCont, expanding ? data.fullDescriptionHTML : data.truncatedDescriptionHTML, expanding);
          toggleButton.textContent = expanding ? 'Close' : 'Read full article';
        });
      });
    }
    
    // Update pagination controls.
    function updatePaginationControls() {
      const paginationContainer = document.getElementById('pagination');
      paginationContainer.innerHTML = '';
      
      const prevButton = document.createElement('button');
      prevButton.textContent = '<';
      if (currentPage === 1) prevButton.classList.add('disabled');
      prevButton.addEventListener('click', () => {
        if (currentPage > 1) {
          currentPage--;
          renderPage(currentPage);
          updatePaginationControls();
        }
      });
      paginationContainer.appendChild(prevButton);
      
      for (let i = 1; i <= totalPages; i++) {
        const pageButton = document.createElement('button');
        pageButton.textContent = i;
        if (i === currentPage) pageButton.classList.add('active');
        pageButton.addEventListener('click', () => {
          currentPage = i;
          renderPage(currentPage);
          updatePaginationControls();
        });
        paginationContainer.appendChild(pageButton);
      }
      
      const nextButton = document.createElement('button');
      nextButton.textContent = '>';
      if (currentPage === totalPages) nextButton.classList.add('disabled');
      nextButton.addEventListener('click', () => {
        if (currentPage < totalPages) {
          currentPage++;
          renderPage(currentPage);
          updatePaginationControls();
        }
      });
      paginationContainer.appendChild(nextButton);
    }
    
    // Fetch and parse the RSS feed.
    fetch(feedUrl)
      .then(response => response.text())
      .then(str => {
        const parser = new DOMParser();
        const xml = parser.parseFromString(str, "application/xml");
        const items = xml.querySelectorAll('item');
        items.forEach(item => {
          const title = item.querySelector('title')?.textContent || 'No Title';
          const description = item.querySelector('description')?.textContent || 'No Description';
          const link = item.querySelector('link')?.textContent || '#';
          const categoryText = item.querySelector('category')?.textContent || '';
          const categories = categoryText.split(',').map(cat => cat.trim()).filter(Boolean);
          const rawPubDate = item.querySelector('pubDate')?.textContent;
          const formattedPubDate = rawPubDate 
            ? new Date(rawPubDate).toLocaleDateString(undefined, { year: 'numeric', month: 'long', day: 'numeric' })
            : 'No Date';
          const source = item.querySelector('link')?.textContent || 'No source';
          const fullDescriptionHTML = convertToParagraphs(description);
          const truncatedDescriptionHTML = getTruncatedParagraphs(description);
          feedItemsData.push({
            title,
            fullDescriptionHTML,
            truncatedDescriptionHTML,
            pubDate: formattedPubDate,
            source,
            link,
            categories
          });
        });
        totalPages = Math.ceil(feedItemsData.length / itemsPerPage);
        renderPage(currentPage);
        updatePaginationControls();
      })
      .catch(error => {
        console.error('Error fetching RSS feed:', error);
        document.getElementById('feed').innerHTML = '<p>Error loading feed.</p>';
      });
  </script>
</body>
</html>
